try{speeddial.storage.open();speeddial.storage.createTable();sync_add_group=function(id,group){return speeddial.storage.sync_add_group(id,group)};sync_edit_group=function(id,group){return speeddial.storage.sync_edit_group(id,group)};sync_remove_group=function(id){return speeddial.storage.sync_remove_group(id)};sync_order_groups=function(groups){return speeddial.storage.sync_order_groups(groups)};sync_add_bookmark=function(id,bookmark){return speeddial.storage.sync_add_bookmark(id,bookmark)};sync_edit_bookmark=function(id,bookmark){return speeddial.storage.sync_edit_bookmark(id,bookmark)};sync_move_bookmark=function(id,group){return speeddial.storage.sync_move_bookmark(id,group)};sync_remove_bookmark=function(id){return speeddial.storage.sync_remove_bookmark(id)};sync_order_bookmarks=function(bookmarks){return speeddial.storage.sync_order_bookmarks(bookmarks)};sync_to_server=function(callback){return speeddial.storage.sync_to_server(callback)};sync_settings=function(){return speeddial.storage.sync_settings()};import_settings=function(settings,callback){return speeddial.storage.import_settings(settings,callback)};test_sync_account=function(callback){return speeddial.storage.test_sync_account(callback)};sync=function(callback){return speeddial.storage.sync(callback)};merge_or_sync=function(callback,allowMerge){return speeddial.storage.merge_or_sync(callback,allowMerge)};backup=function(callback){return speeddial.storage.backup(callback)};get_user_backups=function(callback){return speeddial.storage.get_user_backups(callback)};upload=function(file,size,callback){return speeddial.storage.upload(file,size,callback)};sync_usage=function(){try{speeddial.storage.sync_usage()}catch(e){console.log(e)}};get_user_token=function(user,callback){return speeddial.storage.get_user_token(user,callback)};charge=function(data,callback){return speeddial.storage.charge(data,callback)};sign_up=function(user,callback){return speeddial.storage.sign_up(user,callback)};create_group=function(group,callback){return speeddial.storage.addGroup(group,callback)};setTimeout(function(){backup()},1e3);setTimeout(function(){sync()},25e3);chrome.alarms.create("sync",{periodInMinutes:360});chrome.alarms.onAlarm.addListener(function(alarm){if(alarm&&alarm.name=="sync"){console.log("["+Date.now()+"] Synchronizing ...");sync()}});function makeThumbnail(url,captureDelay){setTimeout(function(){try{chrome.tabs.captureVisibleTab(null,{format:"png"},function(dataurl){var canvas=document.createElementNS("http://www.w3.org/1999/xhtml","html:canvas");var ctx=canvas.getContext("2d");var img=document.createElement("img");img.onload=function(){try{resized_width=460;quality=.65;if(localStorage["options.thumbnailQuality"]=="low"){resized_width=360;quality=.65}if(localStorage["options.thumbnailQuality"]=="high"){resized_width=720;quality=.65}resized_height=Math.ceil(resized_width/img.width*img.height);canvas.width=resized_width;canvas.height=resized_height;ctx.drawImage(img,0,0,resized_width,resized_height);speeddial.storage.db.transaction(function(tx){tx.executeSql("DELETE FROM thumbnails WHERE url = ?",[url],function(){tx.executeSql("INSERT INTO thumbnails (url, thumbnail) values (?, ?)",[url,canvas.toDataURL("image/jpeg",quality)],null,function(tx,e){alert("Something unexpected happened: "+e.message)})})});img=null}catch(e){console.log(e)}};img.src=dataurl})}catch(e){console.log(e)}},captureDelay)}chrome.tabs.onUpdated.addListener(function(id,object,tab){try{if(tab.selected&&tab.url){if(localStorage["requestThumbnail"]&&localStorage["requestThumbnail"]!=""&&localStorage["requestThumbnail"]!="undefined"&&typeof localStorage["requestThumbnail"]!="undefined"){var requestThumbnail=localStorage["requestThumbnail"].split("|||");if(requestThumbnail[0]==tab.id){if(tab.status=="complete"){if(tab.url.indexOf("mail.google.com")>-1||tab.url.indexOf("twitter.com")>-1){if(validateUrl(tab.url))makeThumbnail(requestThumbnail[1],1e3)}else{if(validateUrl(tab.url))makeThumbnail(requestThumbnail[1],135)}localStorage["requestThumbnail"]=""}requestThumbnail=null}}}}catch(e){console.log(e)}});chrome.tabs.onCreated.addListener(function(tab){if(localStorage["refresh_create"]=="true"){localStorage["refresh_url"]="";localStorage["refresh_create"]="false";localStorage["refresh_id"]="";localStorage["refreshThumbnail"]=""}if(localStorage["refreshThumbnail"]!=""){localStorage["refresh_url"]=localStorage["refreshThumbnail"];localStorage["refresh_create"]="true";localStorage["refresh_id"]=tab.id;localStorage["refreshThumbnail"]=""}});chrome.tabs.onUpdated.addListener(function(id,object,tab){if(localStorage["refreshThumbnail"]!=""){localStorage["refresh_url"]=localStorage["refreshThumbnail"];localStorage["refresh_create"]="true";localStorage["refresh_id"]=tab.id;localStorage["refreshThumbnail"]=""}});chrome.tabs.onSelectionChanged.addListener(function(tabId,selectInfo){if(tabId){try{chrome.tabs.getSelected(null,function(tab){if(tab){if(localStorage["refresh_create"]=="true"){if(tab.selected&&tab.url&&tab.id==localStorage["refresh_id"]){var url=localStorage["refresh_url"];if(tab.status=="complete"){localStorage["refresh_url"]="";localStorage["refresh_create"]="false";localStorage["refresh_id"]="";localStorage["refreshThumbnail"]="";if(url.indexOf("mail.google.com")>-1||url.indexOf("twitter.com")>-1){if(validateUrl(url))makeThumbnail(url,1e3)}else{if(validateUrl(url))makeThumbnail(url,145)}}}}}})}catch(e){console.log(e)}}});chrome.tabs.onUpdated.addListener(function(id,object,tab){if(localStorage["refresh_create"]=="true"){if(tab){if(tab.selected&&tab.url&&tab.id==localStorage["refresh_id"]){var url=localStorage["refresh_url"];if(tab.status=="complete"){localStorage["refresh_url"]="";localStorage["refresh_create"]="false";localStorage["refresh_id"]="";localStorage["refreshThumbnail"]="";if(url.indexOf("mail.google.com")>-1||url.indexOf("twitter.com")>-1){if(validateUrl(url))makeThumbnail(url,1e3)}else{if(validateUrl(url))makeThumbnail(url,135)}}}}}});function contextmenu_addGroup(row,tab){var value=[];value["title"]=tab.title;value["url"]=encodeURI(tab.url);value["idgroup"]=row.id;speeddial.storage.addItem(value,function(){});if(tab.url&&validateUrl(tab.url))makeThumbnail(tab.url,0)}function contextmenu_createGroup(row){chrome.contextMenus.create({title:row.title,contexts:["all"],parentId:selectGroups,type:"normal",onclick:function(info,tab){contextmenu_addGroup(row,tab)}})}function getGroups(callback){var g=[];speeddial.storage.db.transaction(function(tx){tx.executeSql("SELECT * FROM groups ORDER BY position ASC",[],function(tx,rs){if(rs.rows.length>0){for(var i=0;i<rs.rows.length;i++){g.push(rs.rows.item(i))}return callback(g)}})})}function addCurrentPage(group,callback){chrome.tabs.query({windowId:chrome.windows.WINDOW_ID_CURRENT,active:true},function(tabs){if(tabs&&tabs[0]){tab=tabs[0];if(!tab||!tab.url||!tab.title)return;var value=[];value["title"]=tab.title;value["url"]=encodeURI(tab.url);value["thumbnail"]="";value["idgroup"]=group||0;speeddial.storage.addItem(value,function(){});if(tab.url&&validateUrl(tab.url)){makeThumbnail(tab.url,0)}return callback()}})}function contextmenu_loadGroups(){speeddial.storage.db.transaction(function(tx){tx.executeSql("SELECT * FROM groups ORDER BY position ASC",[],function(tx,rs){if(rs.rows.length>0){chrome.contextMenus.create({type:"separator",parentId:rootElement});selectGroups=chrome.contextMenus.create({title:"Add to group",contexts:["all"],parentId:rootElement,type:"normal"});for(var i=0;i<rs.rows.length;i++){contextmenu_createGroup(rs.rows.item(i))}}})})}if(localStorage["options.showContextMenu"]=="1"){var selectGroups;var rootElement=chrome.contextMenus.create({contexts:["all"],title:"Speed dial 2",type:"normal"});chrome.contextMenus.create({title:"Add current page",contexts:["all"],parentId:rootElement,type:"normal",onclick:function(info,tab){var value=[];value["title"]=tab.title;value["url"]=encodeURI(tab.url);value["thumbnail"]="";value["idgroup"]=0;speeddial.storage.addItem(value,function(){});if(tab.url&&validateUrl(tab.url)){makeThumbnail(tab.url,0)}}});chrome.contextMenus.create({type:"separator",parentId:rootElement});chrome.contextMenus.create({title:"Add all opened pages",contexts:["all"],parentId:rootElement,type:"normal",onclick:function(info,tab){chrome.tabs.getAllInWindow(null,function(tabs){for(var i=0;i<tabs.length;i++){if(tabs[i].title!="New tab"){var value=[];value["title"]=tabs[i].title;value["url"]=encodeURI(tabs[i].url);value["idgroup"]=0;speeddial.storage.addItem(value,function(){})}}})}});contextmenu_loadGroups()}if(typeof localStorage["_opened_tabs"]!="undefined"){localStorage["_restore_tabs"]=localStorage["_opened_tabs"]}localStorage.removeItem("_opened_tabs");localStorage.removeItem("_tmp_pinboard.tags");chrome.tabs.onUpdated.addListener(function(tabId,changeInfo,tab){if(tab&&tab.url&&tab.title&&tab.incognito===false){if(typeof localStorage["_opened_tabs"]!="undefined"){var obj=JSON.parse(localStorage["_opened_tabs"])}else{var obj={}}obj[tabId]={};obj[tabId].url=tab.url;obj[tabId].title=tab.title;obj[tabId].pinned=tab.pinned;localStorage["_opened_tabs"]=JSON.stringify(obj,null,2)}});chrome.tabs.onRemoved.addListener(function(tabId,tabInfo){if(typeof localStorage["_opened_tabs"]!="undefined"){var obj=JSON.parse(localStorage["_opened_tabs"]);if(!obj[tabId])return false;var tab=obj[tabId];delete obj[tabId];localStorage["_opened_tabs"]=JSON.stringify(obj,null,2);var url=tab.url;var title=tab.title;var re=/^(http:|https:|ftp:|file:)/;if(url&&re.test(url)){if(typeof localStorage["_closed_tabs"]!="undefined"){closedTabs=JSON.parse(localStorage["_closed_tabs"]);for(var i=0;i<closedTabs.length;i++){if(closedTabs[i].url==url){closedTabs.splice(i,1)}}closedTabs.push({url:url,title:title});while(closedTabs.length>25){closedTabs.shift()}localStorage["_closed_tabs"]=JSON.stringify(closedTabs,null,2)}else{closedTabs=[];closedTabs.push({url:url,title:title});localStorage["_closed_tabs"]=JSON.stringify(closedTabs,null,2)}}obj=null}});chrome.extension.onRequest.addListener(function(request,sender,sendResponse){});if(chrome&&chrome.runtime&&chrome.runtime.setUninstallURL){chrome.runtime.setUninstallURL("https://speeddial2.com/uninstall")}chrome.runtime.onInstalled.addListener(function(details){if(details&&details.reason&&details.reason=="install")chrome.tabs.create({url:"newtab.html"})});if(localStorage["usage.uuid"]&&localStorage["usage.interval"]&&localStorage["usage.last"]){if(Math.round(+new Date/1e3)-localStorage["usage.last"]>localStorage["usage.interval"]){sync_usage()}}}catch(e){console.log(e)}