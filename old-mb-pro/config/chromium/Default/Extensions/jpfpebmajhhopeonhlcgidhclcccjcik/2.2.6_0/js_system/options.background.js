function dataURItoBlob(dataURI,callback){var byteString=atob(dataURI.split(",")[1]);var mimeString=dataURI.split(",")[0].split(":")[1].split(";")[0];var ab=new ArrayBuffer(byteString.length);var ia=new Uint8Array(ab);for(var i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i)}var bb=new window.WebKitBlobBuilder;bb.append(ab);return bb.getBlob(mimeString)}function strstr(haystack,needle,bool){var pos=0;haystack+="";pos=haystack.indexOf(needle);if(pos==-1){return false}else{if(bool){return haystack.substr(0,pos)}else{return haystack.slice(pos)}}}window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;function fileErrorHandler(e){var msg="";var securityErr=0;switch(e.code){case FileError.QUOTA_EXCEEDED_ERR:msg="Speed Dial 2's thumbnail file storage limit has been reached.";break;case FileError.NOT_FOUND_ERR:msg="Speed Dial 2 is unable to access one or more thumbnail files.\n\nYou may need to reinstall Speed Dial 2 and/or Chrome.";break;case FileError.SECURITY_ERR:securityErr=1;break;case FileError.INVALID_MODIFICATION_ERR:msg="Speed Dial 2 is unable to modify its thumbnail files.";break;case FileError.INVALID_STATE_ERR:msg="Speed Dial 2 is unable to access its thumbnail files (invalid state).";break;default:msg="Speed Dial 2 has encountered an unknown thumbnail file error.";break}if(securityErr==1){window.webkitNotifications.createHTMLNotification("/html/notification_fileSecurityErr.html").show();return}if(localStorage.option_alert==1){alert(msg)}}$(document).on("change","#backgroundFile",function(e){var file=e.target.files[0];if(!strstr(file.type,"image/")){alert("Error: File is not an image.");return}var reader=new FileReader;reader.onload=function(theFile){return function(e){window.requestFileSystem(window.PERSISTENT,50*1024*1024,function(fs){fs.root.getFile("/background.image",{create:true},function(fileEntry){fileEntry.createWriter(function(fileWriter){fileWriter.write(dataURItoBlob(e.target.result));setTimeout(function(){$("#backgroundFile").val("");setValue("options.background","filesystem:"+chrome.extension.getURL("persistent/background.image"));setValue("options.backgroundPattern","");show_message("Background set.")},1)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)}}(file);reader.readAsDataURL(file)});